<%- include('../partials/user/header') %>

<style>
  .qty-btn_area {
    margin-top: 20px;
  }
  .qty-btn_area ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    gap: 12px;
    align-items: center;
  }
  .qty-btn_area ul li {
    display: inline-block;
  }
  .qty-cart_btn {
    background: #333333;
    color: #ffffff;
    font-size: 15px;
    font-weight: 500;
    height: 45px;
    line-height: 45px;
    padding: 0 28px;
    text-align: center;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease-in-out;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  .qty-cart_btn:hover {
    background: #1d2951;
    color: #ffffff;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
  }
  .qty-cart_btn:active {
    transform: translateY(1px);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }
  .qty-wishlist_btn {
    background: #ffffff;
    border: 1px solid #ddd;
    color: #333333;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    height: 45px;
    width: 45px;
    border-radius: 4px;
    transition: all 0.3s ease-in-out;
    text-decoration: none;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  }
  .qty-wishlist_btn:hover {
    border-color: #1d2951;
    color: #1d2951;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }
  .qty-wishlist_btn:active {
    transform: translateY(1px);
    box-shadow: none;
  }
  .qty-wishlist_btn i {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .quantity {
    display: flex;
    flex-direction: column;
    margin-bottom: 20px;
  }
  .quantity label {
    margin-bottom: 8px;
    font-weight: 500;
    color: #333;
  }
  .cart-plus-minus {
    display: flex;
    align-items: center;
    border: 1px solid #e5e5e5;
    border-radius: 4px;
    max-width: 130px;
    height: 42px;
    overflow: hidden;
  }
  .cart-plus-minus-box {
    border: none;
    text-align: center;
    width: 60px;
    height: 40px;
    font-size: 15px;
    margin: 0;
  }
  .qtybutton {
    background: #f7f7f7;
    cursor: pointer;
    width: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    transition: all 0.2s ease;
  }
  .qtybutton:hover {
    background: #e0e0e0;
  }
  .product-info {
    margin-bottom: 25px;
  }
  .product-info h3 {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 15px;
    color: #333;
  }
  .product-price {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }
  .rating-box {
    margin-bottom: 15px;
  }
  .rating-box ul {
    display: flex;
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .rating-box ul li {
    margin-right: 2px;
    color: #ffc107;
  }
  .rating-box ul li.silver-color {
    color: #d5d5d5;
  }
  [style*="color: red"] {
    font-weight: 500;
    display: inline-flex;
    align-items: center;
  }
  [style*="color: red"]:before {
    content: "•";
    display: inline-block;
    margin-right: 5px;
    font-size: 20px;
  }
  [style*="color: green"] {
    font-weight: 500;
    display: inline-flex;
    align-items: center;
  }
  [style*="color: green"]:before {
    content: "•";
    display: inline-block;
    margin-right: 5px;
    font-size: 20px;
  }
  .product-description h4,
  .product-description h5 {
    margin-bottom: 15px;
    color: #333;
    font-weight: 600;
  }
  .product-description p {
    line-height: 1.6;
    color: #666;
    margin-bottom: 20px;
  }
  .product-features ul {
    padding-left: 20px;
    margin-bottom: 20px;
  }
  .product-features li {
    margin-bottom: 8px;
    position: relative;
    padding-left: 5px;
    line-height: 1.5;
  }
  .product-specs table {
    border-collapse: collapse;
    width: 100%;
    margin-bottom: 20px;
  }
  .product-specs td {
    padding: 10px 15px;
    border: 1px solid #ddd;
    line-height: 1.5;
  }
  .product-specs tr td:first-child {
    width: 30%;
    background-color: #f9f9f9;
    font-weight: 500;
  }
  .mt-4 {
    margin-top: 1.5rem;
  }
  input[type=number]::-webkit-inner-spin-button,
  input[type=number]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  input[type=number] {
    -moz-appearance: textfield;
  }
  @media (max-width: 768px) {
    .qty-cart_btn {
      padding: 0 20px;
      font-size: 14px;
    }
    .product-specs tr td:first-child {
      width: 40%;
    }
  }
  @media (max-width: 576px) {
    .product-price {
      flex-direction: column;
      align-items: flex-start;
    }
  }
</style>

<!-- Begin Hiraola's Breadcrumb Area -->
<% if (product) { %>
  <div class="breadcrumb-area">
    <div class="container">
      <div class="breadcrumb-content">
        <h2>Single Product Type</h2>
        <ul>
          <li><a href="/home">Home</a></li>
          <li class="active"><%= product.productName %></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Begin Hiraola's Single Product Area -->
  <div class="sp-area">
    <div class="container">
      <div class="sp-nav">
        <div class="row">
          <div class="col-lg-5 col-md-5">
            <div class="sp-img_area">
              <div class="zoompro-border">
                <img
                  class="zoompro"
                  src="<%= product.productImage[0] %>"
                  data-zoom-image="<%= product.productImage[0] %>"
                  alt="<%= product.productName %> Image"
                  onerror="console.log('Main image failed to load: <%= product.productImage[0] %>')"
                />
              </div>
              <div id="gallery" class="sp-img_slider">
                <% product.productImage.forEach((image, index) => { %>
                  <a
                    class="<%= index === 0 ? 'active' : '' %>"
                    data-image="<%= image %>"
                    data-zoom-image="<%= image %>"
                  >
                    <img
                      src="<%= image %>"
                      alt="<%= product.productName %>'s Image"
                      onerror="console.log('Thumbnail image failed to load: <%= image %>')"
                    />
                  </a>
                <% }); %>
              </div>
            </div>
          </div>
          <div class="col-lg-7 col-md-7">
            <div class="product-info">
              <h3><%= product.productName %></h3>
              <div class="product-price">
                <span>₹<%= product.price.toFixed(2) %></span>
              </div>
            </div>

            <div class="sp-content">
              <div class="rating-box">
                <ul>
                  <li><i class="fa fa-star-of-david"></i></li>
                  <li><i class="fa fa-star-of-david"></i></li>
                  <li><i class="fa fa-star-of-david"></i></li>
                  <li><i class="fa fa-star-of-david"></i></li>
                  <li class="silver-color">
                    <i class="fa fa-star-of-david"></i>
                  </li>
                </ul>
              </div>

              <a href="#">
                <% if (product.totalStock == 0) { %>
                  <span style="color: red;">Out Of Stock</span>
                <% } else { %>
                  <span style="color: green;"><%= product.totalStock %> Item Available</span>
                <% } %>
              </a>

              <div class="quantity">
                <label>Quantity</label>
                <div class="cart-plus-minus">
                  <input class="cart-plus-minus-box" value="1" type="text" />
                  <div class="dec qtybutton">
                    <i class="fa fa-angle-down"></i>
                  </div>
                  <div class="inc qtybutton"><i class="fa fa-angle-up"></i></div>
                </div>
              </div>

              <div class="qty-btn_area">
                <ul>
                  <li>
                    <button
                      type="button"
                      class="qty-cart_btn"
                      data-bs-toggle="tooltip"
                      title="Add To Cart"
                      onclick="addToCart('<%= product._id %>')"
                    >
                      Add To Cart
                    </button>
                  </li>
                  <li>
                    <a
                      class="qty-wishlist_btn"
                      href="/wishlist"
                      data-bs-toggle="tooltip"
                      title="Add To Wishlist"
                      data-product-id="<%= product._id %>"
                    >
                      <i class="ion-android-favorite-outline"></i>
                    </a>
                  </li>
                </ul>
              </div>

              <br><br><br>

              <div class="product-description-container">
                <h4>About This <%= product.productName %></h4>
                <p><%= product.description %></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Begin Hiraola's Single Product Tab Area -->
  <div class="hiraola-product-tab_area-2 sp-product-tab_area">
    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          <div class="sp-product-tab_nav">
            <div class="product-tab">
              <ul class="nav product-menu">
                <li>
                  <a class="active" data-bs-toggle="tab" href="#description"><span>Description</span></a>
                </li>
                <li>
                  <a data-bs-toggle="tab" href="#reviews"><span>Reviews (1)</span></a>
                </li>
              </ul>
            </div>
            <div class="tab-content hiraola-tab_content">
              <div id="description" class="tab-pane active show" role="tabpanel">
                <div class="product-description">
                  <h4>Product Details</h4>
                  <p><%= product.description %></p>

                  <div class="product-features mt-4">
                    <h5>Key Features</h5>
                    <ul>
                      <% if (product.features && product.features.length > 0) { %>
                        <% product.features.forEach(feature => { %>
                          <li><%= feature %></li>
                        <% }); %>
                      <% } else { %>
                        <li>Premium quality</li>
                        <li>Durable construction</li>
                        <li>Elegant design</li>
                      <% } %>
                    </ul>
                  </div>

                  <div class="product-specs mt-4">
                    <h5>Specifications</h5>
                    <table class="table table-bordered">
                      <tbody>
                        <% if (product.specifications) { %>
                          <% Object.entries(product.specifications).forEach(([key, value]) => { %>
                            <tr>
                              <td><strong><%= key %></strong></td>
                              <td><%= value %></td>
                            </tr>
                          <% }); %>
                        <% } else { %>
                          <tr>
                            <td><strong>Material</strong></td>
                            <td>Premium material</td>
                          </tr>
                          <tr>
                            <td><strong>Size</strong></td>
                            <td>Standard</td>
                          </tr>
                          <tr>
                            <td><strong>Weight</strong></td>
                            <td>Lightweight</td>
                          </tr>
                        <% } %>
                      </tbody>
                    </table>
                  </div>

                  <div class="product-care mt-4">
                    <h5>Care Instructions</h5>
                    <p><%= product.careInstructions || 'For detailed care instructions, please refer to the product manual.' %></p>
                  </div>
                </div>
              </div>
              <div id="reviews" class="tab-pane" role="tabpanel">
                <div class="tab-pane active" id="tab-review">
                  <form class="form-horizontal" id="form-review">
                    <div id="review">
                      <table class="table table-striped table-bordered">
                        <tbody>
                          <tr>
                            <td style="width: 50%"><strong>Customer</strong></td>
                            <td class="text-right">25/04/2022</td>
                          </tr>
                          <tr>
                            <td colspan="2">
                              <p>Good product! Thank you very much</p>
                              <div class="rating-box">
                                <ul>
                                  <li><i class="fa fa-star-of-david"></i></li>
                                  <li><i class="fa fa-star-of-david"></i></li>
                                  <li><i class="fa fa-star-of-david"></i></li>
                                  <li><i class="fa fa-star-of-david"></i></li>
                                  <li><i class="fa fa-star-of-david"></i></li>
                                </ul>
                              </div>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    <h2>Write a review</h2>
                    <div class="form-group required">
                      <div class="col-sm-12 p-0">
                        <label>Your Email <span class="required">*</span></label>
                        <input
                          class="review-input"
                          type="email"
                          name="con_email"
                          id="con_email"
                          required
                        />
                      </div>
                    </div>
                    <div class="form-group required second-child">
                      <div class="col-sm-12 p-0">
                        <label class="control-label">Share your opinion</label>
                        <textarea
                          class="review-textarea"
                          name="con_message"
                          id="con_message"
                        ></textarea>
                        <div class="help-block">
                          <span class="text-danger">Note:</span> HTML is not translated!
                        </div>
                      </div>
                    </div>
                    <div class="form-group last-child required">
                      <div class="col-sm-12 p-0">
                        <div class="your-opinion">
                          <label>Your Rating</label>
                          <span>
                            <select class="star-rating">
                              <option value="1">1</option>
                              <option value="2">2</option>
                              <option value="3">3</option>
                              <option value="4">4</option>
                              <option value="5">5</option>
                            </select>
                          </span>
                        </div>
                      </div>
                      <div class="hiraola-btn-ps_right">
                        <a href="javascript:void(0)" class="hiraola-btn hiraola-btn_dark">Continue</a>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Begin Hiraola's Product Area Two -->
  <div class="hiraola-product_area hiraola-product_area-2 section-space_add">
    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          <div class="hiraola-section_title">
            <h4>Related Products</h4>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="hiraola-product_slider-3">
            <% relatedProduct.forEach(function(related) { %>
              <div class="slide-item">
                <div class="single_product">
                  <div class="product-img">
                    <a href="/singleproduct/<%= related._id %>">
                      <img
                        class="primary-img"
                        src="<%= related.productImage[0] %>"
                        alt="<%= related.productName %>"
                        onerror="console.log('Related product image failed to load: <%= related.productImage[0] %>')"
                      />
                      <img
                        class="secondary-img"
                        src="<%= related.productImage[1] || related.productImage[0] %>"
                        alt="<%= related.productName %>"
                        onerror="console.log('Related product secondary image failed to load: <%= related.productImage[1] || related.productImage[0] %>')"
                      />
                    </a>
                    <div class="add-actions">
                      <ul>
                        <li>
                          <a
                            class="hiraola-add_cart"
                            href="/cart"
                            data-bs-toggle="tooltip"
                            data-placement="top"
                            title="Add To Cart"
                          ><i class="ion-bag"></i></a>
                        </li>
                        <li
                          class="quick-view-btn"
                          data-bs-toggle="modal"
                          data-bs-target="#exampleModalCenter"
                        >
                          <a
                            href="javascript:void(0)"
                            data-bs-toggle="tooltip"
                            data-placement="top"
                            title="Quick View"
                          ><i class="ion-eye"></i></a>
                        </li>
                      </ul>
                    </div>
                  </div>
                  <div class="hiraola-product_content">
                    <div class="product-desc_info">
                      <h6>
                        <a class="product-name" href="/singleproduct/<%= related._id %>"><%= related.productName %></a>
                      </h6>
                      <div class="price-box">
                        <span class="new-price">₹<%= related.price.toFixed(2) %></span>
                      </div>
                      <div class="additional-add_action">
                        <ul>
                          <li>
                            <a
                              class="hiraola-add_compare"
                              href="/wishlist"
                              data-bs-toggle="tooltip"
                              data-placement="top"
                              title="Add To Wishlist"
                            ><i class="ion-android-favorite-outline"></i></a>
                          </li>
                        </ul>
                      </div>
                      <div class="rating-box">
                        <ul>
                          <li><i class="fa fa-star-of-david"></i></li>
                          <li><i class="fa fa-star-of-david"></i></li>
                          <li><i class="fa fa-star-of-david"></i></li>
                          <li><i class="fa fa-star-of-david"></i></li>
                          <li class="silver-color"><i class="fa fa-star-of-david"></i></li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            <% }); %>
          </div>
        </div>
      </div>
    </div>
  </div>
<% } else { %>
  <div class="container">
    <p>Error: Product not found.</p>
    <a href="/shop">Back to Shop</a>
  </div>
<% } %>

<%- include('../partials/user/footer') %>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/elevatezoom/2.2.3/jquery.elevatezoom.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
 $(document).ready(function () {
  // First, destroy any existing instances to prevent conflicts
  $('.zoompro').elevateZoom('destroy');
  
  // Initialize zoom with improved settings
  $(".zoompro").elevateZoom({
    gallery: "gallery",
    galleryActiveClass: "active",
    zoomType: "inner", // Changed to 'inner' for better mobile compatibility
    cursor: "crosshair",
    responsive: true,
    zoomWindowFadeIn: 500,
    zoomWindowFadeOut: 500,
    easing: true
  });

  // Better event handler for gallery thumbnails
  $("#gallery a").on("click", function (e) {
    e.preventDefault();
    
    // Update active class manually to ensure visual indication works
    $("#gallery a").removeClass("active");
    $(this).addClass("active");
    
    var newImage = $(this).data("image");
    var newZoomImage = $(this).data("zoom-image");
    
    // Update image
    $('.zoompro').attr('src', newImage);
    $('.zoompro').data('zoom-image', newZoomImage);
    
    // Reinitialize zoom for the new image
    $('.zoompro').elevateZoom('destroy');
    $('.zoompro').elevateZoom({
      gallery: "gallery",
      galleryActiveClass: "active",
      zoomType: "inner",
      cursor: "crosshair",
      responsive: true,
      zoomWindowFadeIn: 500,
      zoomWindowFadeOut: 500,
      easing: true
    });
  });
  
  // Fix for mobile devices
  $(window).resize(function() {
    $('.zoompro').elevateZoom('destroy');
    setTimeout(function() {
      $('.zoompro').elevateZoom({
        gallery: "gallery",
        galleryActiveClass: "active",
        zoomType: window.innerWidth < 768 ? "inner" : "window",
        cursor: "crosshair",
        responsive: true,
        zoomWindowFadeIn: 500,
        zoomWindowFadeOut: 500,
        easing: true
      });
    }, 300);
  });
});

  const MAX_QUANTITY = 7;

  async function addToCart(productId) {
    console.log("Entering addToCart method");
    const quantity = document.querySelector(".cart-plus-minus-box").value;
    console.log("Quantity:", quantity);

    try {
      const response = await fetch("/addtocart/" + productId, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          productId: productId,
          quantity: quantity,
        }),
      });

      const data = await response.json();

      if (response.ok) {
        Swal.fire({
          icon: "success",
          title: "Success!",
          text: "Product added to cart successfully!",
          showConfirmButton: false,
          timer: 1500,
        });

        if (data.cartCount) {
          const cartCountElement = document.querySelector(".cart-count");
          if (cartCountElement) {
            cartCountElement.textContent = data.cartCount;
          }
        }
      } else {
        let errorMessage = data.message || "Failed to add product to cart";
        let isProductBlocked = errorMessage.includes("blocked") ||
                              errorMessage.includes("disabled") ||
                              errorMessage.includes("not available");

        if (errorMessage.includes("undefined")) {
          errorMessage = "This item is out of stock.";
        }

        if (isProductBlocked) {
          errorMessage = "This product is no longer available.";
          Swal.fire({
            icon: "error",
            title: "Product Unavailable",
            text: errorMessage,
            confirmButtonText: "OK",
          }).then((result) => {
            if (result.isConfirmed) {
              window.location.href = "/shop";
            }
          });
        } else {
          Swal.fire({
            icon: "error",
            title: "Failed to Add to Cart",
            text: errorMessage,
          });
        }
      }
    } catch (error) {
      console.error("Error:", error);
      Swal.fire({
        icon: "warning",
        title: "Please Login",
        text: "Please login to continue",
        showCancelButton: true,
        confirmButtonText: "Login",
        cancelButtonText: "Cancel",
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = "/login";
        }
      });
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    const quantityInput = document.querySelector(".cart-plus-minus-box");
    const productStock = "<%= product ? product.totalStock : 0 %>";

    document.querySelector(".inc.qtybutton").addEventListener("click", function () {
      const currentVal = parseInt(quantityInput.value);
      const maxAllowed = Math.min(MAX_QUANTITY, productStock);

      if (currentVal < maxAllowed) {
        quantityInput.value = currentVal + 1;
      } else {
        if (currentVal >= MAX_QUANTITY) {
          Swal.fire({
            icon: "error",
            title: "Quantity Limit",
            text: `Maximum quantity per product is ${MAX_QUANTITY}`,
          });
        } else {
          Swal.fire({
            icon: "error",
            title: "Stock Limit",
            text: `Only ${productStock} items available in stock`,
          });
        }
      }
    });

    document.querySelector(".dec.qtybutton").addEventListener("click", function () {
      if (parseInt(quantityInput.value) > 1) {
        quantityInput.value = parseInt(quantityInput.value) - 1;
      }
    });
  });

  document.addEventListener("DOMContentLoaded", function() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('error')) {
      Swal.fire({
        icon: "error",
        title: "Product Unavailable",
        text: "This product is not available or has been blocked.",
        confirmButtonText: "OK",
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = "/shop";
        }
      });
    }
  });

  document.addEventListener('DOMContentLoaded', function() {
    const wishlistButtons = document.querySelectorAll('.qty-wishlist_btn');

    wishlistButtons.forEach(button => {
      button.addEventListener('click', function(event) {
        event.preventDefault();

        const productId = button.getAttribute('data-product-id');

        fetch('/wishlist/add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ productId: productId }),
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const icon = button.querySelector('i');
            icon.classList.remove('ion-android-favorite-outline');
            icon.classList.add('ion-android-favorite');
            button.setAttribute('title', 'Added to Wishlist');

            Swal.fire({
              icon: 'success',
              title: 'Success!',
              text: 'Product added to wishlist successfully!',
              toast: true,
              position: 'top-end',
              showConfirmButton: false,
              timer: 3000,
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Oops...',
              text: data.message || 'Failed to add product to wishlist',
              toast: true,
              position: 'top-end',
              showConfirmButton: false,
              timer: 3000,
            });
          }
        })
        .catch(error => {
          console.error('Error:', error);
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'An error occurred while adding the product to the wishlist',
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
          });
        });
      });
    });
  });
</script>