<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Single Product - <%= product ? product.productName : 'Product Not Found' %></title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .qty-btn_area {
            margin-top: 20px;
        }
        .qty-btn_area ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .qty-btn_area ul li {
            display: inline-block;
        }
        .qty-cart_btn {
            background: #333333;
            color: #ffffff;
            font-size: 15px;
            font-weight: 500;
            height: 45px;
            line-height: 45px;
            padding: 0 28px;
            text-align: center;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .qty-cart_btn:hover {
            background: #1d2951;
            color: #ffffff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }
        .qty-cart_btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .qty-wishlist_btn {
            background: #ffffff;
            border: 1px solid #ddd;
            color: #333333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            height: 45px;
            width: 45px;
            border-radius: 4px;
            transition: all 0.3s ease-in-out;
            text-decoration: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .qty-wishlist_btn:hover {
            border-color: #1d2951;
            color: #1d2951;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .qty-wishlist_btn:active {
            transform: translateY(1px);
            box-shadow: none;
        }
        .qty-wishlist_btn.active {
            background: #ffc107;
            color: #ffffff;
            border-color: #e0a800;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .qty-wishlist_btn.active i {
            font-family: "Ionicons";
        }
        .qty-wishlist_btn i {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .quantity {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }
        .quantity label {
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        .cart-plus-minus {
            display: flex;
            align-items: center;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            max-width: 130px;
            height: 42px;
            overflow: hidden;
        }
        .cart-plus-minus-box {
            border: none;
            text-align: center;
            width: 60px;
            height: 40px;
            font-size: 15px;
            margin: 0;
        }
        .qtybutton {
            background: #f7f7f7;
            cursor: pointer;
            width: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            transition: all 0.2s ease;
        }
        .qtybutton:hover {
            background: #e0e0e0;
        }
        .product-info {
            margin-bottom: 25px;
        }
        .product-info h3 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        .product-price {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .rating-box {
            margin-bottom: 15px;
        }
        .rating-box ul {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .rating-box ul li {
            margin-right: 2px;
            color: #ffc107;
        }
        .rating-box ul li.silver-color {
            color: #d5d5d5;
        }
        [style*="color: red"] {
            font-weight: 500;
            display: inline-flex;
            align-items: center;
        }
        [style*="color: red"]:before {
            content: "•";
            display: inline-block;
            margin-right: 5px;
            font-size: 20px;
        }
        [style*="color: green"] {
            font-weight: 500;
            display: inline-flex;
            align-items: center;
        }
        [style*="color: green"]:before {
            content: "•";
            display: inline-block;
            margin-right: 5px;
            font-size: 20px;
        }
        .product-description h4,
        .product-description h5 {
            margin-bottom: 15px;
            color: #333;
            font-weight: 600;
        }
        .product-description p {
            line-height: 1.6;
            color: #666;
            margin-bottom: 20px;
        }
        .product-features ul {
            padding-left: 20px;
            margin-bottom: 20px;
        }
        .product-features li {
            margin-bottom: 8px;
            position: relative;
            padding-left: 5px;
            line-height: 1.5;
        }
        .product-specs table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }
        .product-specs td {
            padding: 10px 15px;
            border: 1px solid #ddd;
            line-height: 1.5;
        }
        .product-specs tr td:first-child {
            width: 30%;
            background-color: #f9f9f9;
            font-weight: 500;
        }
        .mt-4 {
            margin-top: 1.5rem;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        @media (max-width: 768px) {
            .qty-cart_btn {
                padding: 0 20px;
                font-size: 14px;
            }
            .product-specs tr td:first-child {
                width: 40%;
            }
        }
        @media (max-width: 576px) {
            .product-price {
                flex-direction: column;
                align-items: flex-start;
            }
        }
        /* Thumbnail Gallery Styling */
        .sp-img_slider {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }
        .sp-img_slider a {
            display: inline-block;
            width: 100px;
            height: 80px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            transition: border-color 0.3s ease;
        }
        .sp-img_slider a.active {
            border-color: #1d2951;
        }
        .sp-img_slider a img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .sp-img_slider a:hover {
            border-color: #1d2951;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        /* Related Product Image Size */
        .hiraola-product_slider-3 .product-img img {
            width: 150px;
            height: 150px;
            object-fit: cover;
        }
        @media (max-width: 768px) {
            .hiraola-product_slider-3 .product-img img {
                width: 120px;
                height: 120px;
            }
        }
    </style>
</head>
<body>
    <%- include('../partials/user/header') %>

    <!-- Begin Hiraola's Breadcrumb Area -->
    <% if (product) { %>
        <div class="breadcrumb-area">
            <div class="container">
                <div class="breadcrumb-content">
                    <h2>Single Product Type</h2>
                    <ul>
                        <li><a href="/home">Home</a></li>
                        <li class="active"><%= product.productName %></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Begin Hiraola's Single Product Area -->
        <div class="sp-area">
            <div class="container">
                <div class="sp-nav">
                    <div class="row">
                        <div class="col-lg-5 col-md-5">
                            <div class="sp-img_area">
                                <div class="zoompro-border">
                                    <img
                                        class="zoompro"
                                        src="<%= product.productImage && product.productImage.length > 0 ? product.productImage[0] : '/images/placeholder.jpg' %>"
                                        data-zoom-image="<%= product.productImage && product.productImage.length > 0 ? product.productImage[0] : '/images/placeholder.jpg' %>"
                                        alt="<%= product.productName %> Image"
                                        onerror="this.src='/images/placeholder.jpg'; console.error('Main image failed to load: <%= product.productImage && product.productImage.length > 0 ? product.productImage[0] : ','%>')"
                                    />
                                </div>
                                <div id="gallery" class="sp-img_slider">
                                    <% product.productImage && product.productImage.forEach((image, index) => { %>
                                        <a
                                            class="<%= index === 0 ? 'active' : '' %>"
                                            data-image="<%= image %>"
                                            data-zoom-image="<%= image %>"
                                        >
                                            <img
                                                src="<%= image %>"
                                                alt="<%= product.productName %>'s Image"
                                                onerror="this.src='/images/placeholder.jpg'; console.error('Thumbnail image failed to load: <%= image %>')"
                                            />
                                        </a>
                                    <% }); %>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-7 col-md-7">
                            <div class="product-info">
                                <h3><%= product.productName %></h3>
                                <div class="product-price">
                                    <% if (product.offer && product.offer.discount > 0) { %>
                                        <span class="old-price" style="color: #ff0000; text-decoration: line-through;">₹<%= product.price.toFixed(2) %></span>
                                        <span class="new-price" style="color: #000000; margin-left: 10px;">₹<%= product.offer.finalPrice.toFixed(2) %></span>
                                        <span class="discount-label" style="color: #2e7d32; font-size: 0.9rem; margin-left: 10px;">(<%= product.offer.discount %>% OFF)</span>
                                    <% } else { %>
                                        <span class="new-price">₹<%= product.price.toFixed(2) %></span>
                                    <% } %>
                                </div>
                            </div>

                            <div class="sp-content">
                                <a href="#">
                                    <% if (product.totalStock == 0) { %>
                                        <span style="color: red;">Out Of Stock</span>
                                    <% } else { %>
                                        <span style="color: green;"><%= product.totalStock %> Item Available</span>
                                    <% } %>
                                </a>

                                <div class="quantity">
                                    <label>Quantity</label>
                                    <div class="cart-plus-minus">
                                        <input class="cart-plus-minus-box" value="1" type="number" min="1" max="<%= product.totalStock %>" />
                                        <div class="dec qtybutton">
                                            <i class="fa fa-angle-down"></i>
                                        </div>
                                        <div class="inc qtybutton"><i class="fa fa-angle-up"></i></div>
                                    </div>
                                </div>

                                <div class="qty-btn_area">
                                    <ul>
                                        <li>
                                            <button
                                                type="button"
                                                class="qty-cart_btn"
                                                data-bs-toggle="tooltip"
                                                title="Add To Cart"
                                                onclick="addToCart('<%= product._id %>', null, true)"
                                                <%= product.totalStock == 0 ? 'disabled' : '' %>
                                            >
                                                Add To Cart
                                            </button>
                                        </li>
                                        <li>
                                            <button
                                                class="qty-wishlist_btn"
                                                data-bs-toggle="tooltip"
                                                title="Add To Wishlist"
                                                data-product-id="<%= product._id %>"
                                                onclick="toggleWishlist('<%= product._id %>')"
                                            >
                                                <i class="ion-android-favorite-outline"></i>
                                            </button>
                                        </li>
                                    </ul>
                                </div>

                                <br><br><br>

                                <div class="product-description-container">
                                    <h4>About This <%= product.productName %></h4>
                                    <p><%= product.description %></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Begin Hiraola's Single Product Tab Area -->
        <div class="hiraola-product-tab_area-2 sp-product-tab_area">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="sp-product-tab_nav">
                            <div class="product-tab">
                                <ul class="nav product-menu">
                                    <li>
                                        <a class="active" data-bs-toggle="tab" href="#description"><span>Description</span></a>
                                    </li>
                                    <li>
                                        <a data-bs-toggle="tab" href="#reviews"><span>Reviews (1)</span></a>
                                    </li>
                                </ul>
                            </div>
                            <div class="tab-content hiraola-tab_content">
                                <div id="description" class="tab-pane active show" role="tabpanel">
                                    <div class="product-description">
                                        <h4>Product Details</h4>
                                        <p><%= product.description %></p>

                                        <div class="product-features mt-4">
                                            <h5>Key Features</h5>
                                            <ul>
                                                <% if (product.features && product.features.length > 0) { %>
                                                    <% product.features.forEach(feature => { %>
                                                        <li><%= feature %></li>
                                                    <% }); %>
                                                <% } else { %>
                                                    <li>Premium quality</li>
                                                    <li>Durable construction</li>
                                                    <li>Elegant design</li>
                                                <% } %>
                                            </ul>
                                        </div>

                                        <div class="product-specs mt-4">
                                            <h5>Specifications</h5>
                                            <table class="table table-bordered">
                                                <tbody>
                                                    <% if (product.specifications) { %>
                                                        <% Object.entries(product.specifications).forEach(([key, value]) => { %>
                                                            <tr>
                                                                <td><strong><%= key %></strong></td>
                                                                <td><%= value %></td>
                                                            </tr>
                                                        <% }); %>
                                                    <% } else { %>
                                                        <tr>
                                                            <td><strong>Material</strong></td>
                                                            <td>Premium material</td>
                                                        </tr>
                                                        <tr>
                                                            <td><strong>Size</strong></td>
                                                            <td>Standard</td>
                                                        </tr>
                                                        <tr>
                                                            <td><strong>Weight</strong></td>
                                                            <td>Lightweight</td>
                                                        </tr>
                                                    <% } %>
                                                </tbody>
                                            </table>
                                        </div>

                                        <div class="product-care mt-4">
                                            <h5>Care Instructions</h5>
                                            <p><%= product.careInstructions || 'For detailed care instructions, please refer to the product manual.' %></p>
                                        </div>
                                    </div>
                                </div>
                                <div id="reviews" class="tab-pane" role="tabpanel">
                                    <div class="tab-pane active" id="tab-review">
                                        <form class="form-horizontal" id="form-review">
                                            <div id="review">
                                                <table class="table table-striped table-bordered">
                                                    <tbody>
                                                        <tr>
                                                            <td style="width: 50%"><strong>Customer</strong></td>
                                                            <td class="text-right"><%= new Date().toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' }) %></td>
                                                        </tr>
                                                        <tr>
                                                            <td colspan="2">
                                                                <p>Good product! Thank you very much</p>
                                                                <div class="rating-box">
                                                                    <ul>
                                                                        <li><i class="fa fa-star"></i></li>
                                                                        <li><i class="fa fa-star"></i></li>
                                                                        <li><i class="fa fa-star"></i></li>
                                                                        <li><i class="fa fa-star"></i></li>
                                                                        <li><i class="fa fa-star"></i></li>
                                                                    </ul>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <h2>Write a review</h2>
                                            <div class="form-group required">
                                                <div class="col-sm-12 p-0">
                                                    <label>Your Email <span class="required">*</span></label>
                                                    <input
                                                        class="review-input"
                                                        type="email"
                                                        name="con_email"
                                                        id="con_email"
                                                        required
                                                    />
                                                </div>
                                            </div>
                                            <div class="form-group required second-child">
                                                <div class="col-sm-12 p-0">
                                                    <label class="control-label">Share your opinion</label>
                                                    <textarea
                                                        class="review-textarea"
                                                        name="con_message"
                                                        id="con_message"
                                                    ></textarea>
                                                    <div class="help-block">
                                                        <span class="text-danger">Note:</span> HTML is not translated!
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group last-child required">
                                                <div class="col-sm-12 p-0">
                                                    <div class="your-opinion">
                                                        <label>Your Rating</label>
                                                        <span>
                                                            <select class="star-rating">
                                                                <option value="1">1</option>
                                                                <option value="2">2</option>
                                                                <option value="3">3</option>
                                                                <option value="4">4</option>
                                                                <option value="5">5</option>
                                                            </select>
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="hiraola-btn-ps_right">
                                                    <a href="javascript:void(0)" class="hiraola-btn hiraola-btn_dark">Continue</a>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Begin Hiraola's Product Area Two -->
        <div class="hiraola-product_area hiraola-product_area-2 section-space_add">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="hiraola-section_title">
                            <h4>Related Products</h4>
                        </div>
                    </div>
                    <div class="col-lg-12">
                        <div class="hiraola-product_slider-3">
                            <% relatedProducts.forEach(function(related) { %>
                                <div class="slide-item">
                                    <div class="single_product">
                                        <div class="product-img">
                                            <a href="/singleproduct/<%= related._id %>">
                                                <img
                                                    class="primary-img"
                                                    src="<%= related.productImage && related.productImage.length > 0 ? related.productImage[0] : '/images/placeholder.jpg' %>"
                                                    alt="<%= related.productName %>"
                                                    onerror="this.src='/images/placeholder.jpg'; console.error('Related product image failed to load: <%= related.productImage && related.productImage.length > 0 ? related.productImage[0] : ',' %>')"
                                                />
                                                <img
                                                    class="secondary-img"
                                                    src="<%= related.productImage && related.productImage.length > 1 ? related.productImage[1] : related.productImage[0] || '/images/placeholder.jpg' %>"
                                                    alt="<%= related.productName %>"
                                                    onerror="this.src='/images/placeholder.jpg'; console.error('Related product secondary image failed to load: <%= related.productImage && related.productImage.length > 1 ? related.productImage[1] : related.productImage[0] %>')"
                                                />
                                            </a>
                                            <div class="add-actions">
                                                <ul>
                                                    <li>
                                                        <a
                                                            class="hiraola-add_cart"
                                                            href="javascript:void(0)"
                                                            data-product-id="<%= related._id %>"
                                                            data-bs-toggle="tooltip"
                                                            data-placement="top"
                                                            title="Add To Cart"
                                                            onclick="addToCart('<%= related._id %>')"
                                                        ><i class="ion-bag"></i></a>
                                                    </li>
                                                    <li>
                                                        <a
                                                            class="hiraola-add_compare"
                                                            href="javascript:void(0)"
                                                            data-product-id="<%= related._id %>"
                                                            data-bs-toggle="tooltip"
                                                            data-placement="top"
                                                            title="<%= userWishlist && userWishlist.includes(related._id.toString()) ? 'Remove from Wishlist' : 'Add To Wishlist' %>"
                                                            onclick="toggleWishlist('<%= related._id %>')"
                                                        ><i class="<%= userWishlist && userWishlist.includes(related._id.toString()) ? 'ion-android-favorite' : 'ion-android-favorite-outline' %>"></i></a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="hiraola-product_content">
                                            <div class="product-desc_info">
                                                <h6>
                                                    <a class="product-name" href="/singleproduct/<%= related._id %>"><%= related.productName %></a>
                                                </h6>
                                                <div class="price-box">
                                                    <% if (related.offer && related.offer.discount > 0) { %>
                                                        <span class="old-price" style="color: #ff0000; text-decoration: line-through;">₹<%= related.price.toFixed(2) %></span>
                                                        <span class="new-price" style="color: #000000;">₹<%= related.offer.finalPrice.toFixed(2) %></span>
                                                        <span class="discount-label" style="color: #2e7d32; font-size: 0.9rem;">(<%= related.offer.discount %>% OFF)</span>
                                                    <% } else { %>
                                                        <span class="new-price">₹<%= related.price.toFixed(2) %></span>
                                                    <% } %>
                                                </div>
                                                <div class="rating-box">
                                                    <ul>
                                                        <% const relRating = related.averageRating || 0;
                                                           const relFullStars = Math.floor(relRating);
                                                           const relHasHalfStar = relRating % 1 >= 0.5;
                                                           const relEmptyStars = 5 - relFullStars - (relHasHalfStar ? 1 : 0);
                                                           for (let i = 0; i < relFullStars; i++) { %>
                                                            <li><i class="fa fa-star"></i></li>
                                                        <% } %>
                                                        <% if (relHasHalfStar) { %>
                                                            <li><i class="fa fa-star-half-alt"></i></li>
                                                        <% } %>
                                                        <% for (let i = 0; i < relEmptyStars; i++) { %>
                                                            <li class="silver-color"><i class="fa fa-star"></i></li>
                                                        <% } %>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <% } else { %>
        <div class="container">
            <p>Error: Product not found.</p>
            <a href="/shop">Back to Shop</a>
        </div>
    <% } %>

    <%- include('../partials/user/footer') %>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/elevatezoom/3.0.8/jquery.elevatezoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:3000' : window.location.origin;

        $(document).ready(function () {
            // Initialize elevateZoom on the main image
            function initializeZoom() {
                try {
                    $('.zoompro').elevateZoom({
                        zoomType: 'inner',
                        cursor: 'crosshair',
                        gallery: 'gallery',
                        galleryActiveClass: 'active',
                        zoomWindowFadeIn: 500,
                        zoomWindowFadeOut: 500,
                        responsive: true,
                        scrollZoom: true,
                        easing: true,
                        zoomLevel: 1,
                        borderSize: 1,
                        borderColour: '#ddd',
                        errorCallback: function() {
                            console.error('Zoom initialization failed');
                        }
                    });
                } catch (error) {
                    console.error('Zoom initialization error:', error);
                }
            }

            // Initial zoom setup
            initializeZoom();

            // Handle thumbnail clicks
            $('#gallery a').on('click', function (e) {
                e.preventDefault();
                $('#gallery a').removeClass('active');
                $(this).addClass('active');
                const newImage = $(this).data('image');
                const newZoomImage = $(this).data('zoom-image');
                const $zoompro = $('.zoompro');
                $zoompro.attr('src', newImage).attr('data-zoom-image', newZoomImage);
                $zoompro.removeData('elevateZoom').removeAttr('data-zoom-image');
                $('.zoomContainer').remove();
                $zoompro.attr('data-zoom-image', newZoomImage);
                initializeZoom();
            });

            // Optimize window resize handling
            let resizeTimeout;
            $(window).on('resize', function () {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function () {
                    $('.zoompro').removeData('elevateZoom');
                    $('.zoomContainer').remove();
                    initializeZoom();
                }, 300);
            });

            // Handle image hover for related products
            $('.product-img').hover(
                function() {
                    const $secondaryImg = $(this).find('.secondary-img');
                    if ($secondaryImg.length) {
                        $(this).find('.primary-img').css('opacity', '0');
                        $secondaryImg.css('opacity', '1');
                    }
                },
                function() {
                    const $secondaryImg = $(this).find('.secondary-img');
                    if ($secondaryImg.length) {
                        $(this).find('.primary-img').css('opacity', '1');
                        $secondaryImg.css('opacity', '0');
                    }
                }
            );

            // Initialize tooltips (Bootstrap 4 compatible)
            $('[data-bs-toggle="tooltip"]').tooltip({
                trigger: 'hover'
            });

            // // Quantity buttons
            console.log(product)
const maxStock = <%= product ? product.totalStock : 0 %>;
console.log("maxStock:",maxStock)


// Decrease quantity
$('.dec.qtybutton').on('click', function () {
  const input = $('.cart-plus-minus-box');
  let value = parseInt(input.val());
  if (value > 1) {
    input.add(value);
  }
});

// Increase quantity
$('.inc.qtybutton').on('click', function () {
  const input = $('.cart-plus-minus-box');
  let value = parseInt(input.val());
  if (value < maxStock) {
    input.add(value);
  } else {
    // Optional: Alert when reaching max stock
    Swal.fire({
      icon: 'info',
      title: 'Max stock reached',
      text: `You can only add up to ${maxStock} items.`,
    });
  }
});

// Manual change via input
$('.cart-plus-minus-box').on('change', function () {
  let value = parseInt($(this).val());
  if (isNaN(value) || value < 1) {
    $(this).val(1);
  } else if (value > maxStock) {
    $(this).val(maxStock);
    Swal.fire({
      icon: 'info',
      title: 'Stock limit exceeded',
      text: `Only ${maxStock} items available in stock.`,
    });
  }
});


            // Check wishlist status on page load
            const productId = '<%= product && product._id %>';
            if (productId) {
                checkWishlistStatus(productId);
            }

            // Check wishlist status for related products
            document.querySelectorAll('.hiraola-add_compare').forEach(btn => {
                const relatedProductId = btn.getAttribute('data-product-id');
                if (relatedProductId) {
                    checkWishlistStatus(relatedProductId);
                }
            });
        });

        // Unified addToCart function
        async function addToCart(productId, quantity = 1, fromSingleProduct = false) {
            const addToCartBtn = fromSingleProduct ? document.querySelector('.qty-cart_btn') : document.querySelector(`.hiraola-add_cart[data-product-id="${productId}"]`);
            if (addToCartBtn && addToCartBtn.hasAttribute('disabled')) {
                Swal.fire({
                    icon: 'error',
                    title: 'Out of Stock',
                    text: 'This item is currently out of stock.',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });
                return;
            }

let quantityToAdd = quantity;

if (fromSingleProduct) {
    const input = document.querySelector('.cart-plus-minus-box');
    quantityToAdd = input ? parseInt(input.value) : 1;

    if (isNaN(quantityToAdd) || quantityToAdd < 1) {
                console.error('Invalid quantity:', quantityToAdd);
                this.showNotification('Invalid quantity selected', 'error');
                return;
            }
}

            try {
                console.log('Adding to cart:', { productId, quantity: quantityToAdd, url: `${BASE_URL}/addtocart/${productId}` });
                const response = await fetch(`${BASE_URL}/addtocart/${productId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        quantity: quantityToAdd,
                        fromSingleProduct
                    })
                });

                const data = await response.json();
                console.log('Response from server:', { status: response.status, data });

                if (response.ok && data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: data.message || 'Product added to cart successfully!',
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 3000
                    });
                    const cartCountElement = document.querySelector('.cart-count');
                    if (cartCountElement && data.cartCount) {
                        cartCountElement.textContent = data.cartCount;
                    }
                    if (fromSingleProduct) {
                        animateAddToCart();
                    }
                } else {
                    let errorMessage = data.message || 'Failed to add product to cart';
                    if (errorMessage.includes('undefined') || errorMessage.includes('out of stock')) {
                        errorMessage = 'This item is out of stock.';
                    } else if (errorMessage.includes('login') || response.status === 401) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Please Login',
                            text: 'Please login to add items to your cart.',
                            confirmButtonText: 'OK'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = '/login';
                            }
                        });
                        return;
                    }
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: errorMessage,
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 3000
                    });
                }
            } catch (error) {
                console.error('Error adding to cart:', error);
                Swal.fire({
                    icon: 'warning',
                    title: 'Please Login',
                    text: 'Please login to add items to your cart.',
                    confirmButtonText: 'OK'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = '/login';
                    }
                });
            }
        }

        // Animation for adding to cart
        function animateAddToCart() {
            const cartBtn = document.querySelector('.qty-cart_btn');
            if (cartBtn) {
                cartBtn.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    cartBtn.style.transform = 'scale(1)';
                }, 200);
            }
        }

        // Check if product is in wishlist
        async function checkWishlistStatus(productId) {
            try {
                const response = await fetch(`${BASE_URL}/checkwishlist/${productId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include'
                });
                const data = await response.json();
                if (response.ok && data.isInWishlist) {
                    const wishlistBtn = document.querySelector(`.qty-wishlist_btn[data-product-id="${productId}"]`) || 
                                      document.querySelector(`.hiraola-add_compare[data-product-id="${productId}"]`);
                    if (wishlistBtn) {
                        wishlistBtn.classList.add('active');
                        wishlistBtn.querySelector('i').className = 'ion-android-favorite';
                        $(wishlistBtn).tooltip('hide').attr('data-original-title', 'Remove from Wishlist').tooltip('show');
                    }
                }
            } catch (error) {
                console.error('Error checking wishlist status:', error);
            }
        }

        // Toggle wishlist (add/remove)
        async function toggleWishlist(productId) {
            const wishlistBtn = document.querySelector(`.qty-wishlist_btn[data-product-id="${productId}"]`) || 
                               document.querySelector(`.hiraola-add_compare[data-product-id="${productId}"]`);
            const isActive = wishlistBtn.classList.contains('active');
            const endpoint = isActive ? `${BASE_URL}/wishlist/remove` : `${BASE_URL}/wishlist/add`;

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ productId })
                });

                const data = await response.json();

                if (response.ok) {
                    if (isActive) {
                        wishlistBtn.classList.remove('active');
                        wishlistBtn.querySelector('i').className = 'ion-android-favorite-outline';
                        $(wishlistBtn).tooltip('hide').attr('data-original-title', 'Add To Wishlist').tooltip('show');
                        Swal.fire({
                            icon: 'success',
                            title: 'Removed from Wishlist',
                            text: data.message || 'Product removed from your wishlist!',
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 1500
                        });
                    } else {
                        wishlistBtn.classList.add('active');
                        wishlistBtn.querySelector('i').className = 'ion-android-favorite';
                        $(wishlistBtn).tooltip('hide').attr('data-original-title', 'Remove from Wishlist').tooltip('show');
                        Swal.fire({
                            icon: 'success',
                            title: 'Added to Wishlist',
                            text: data.message || 'Product added to your wishlist!',
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 1500
                        });
                    }
                    // Update related products wishlist buttons
                    const relatedButtons = document.querySelectorAll(`.hiraola-add_compare[data-product-id="${productId}"], .qty-wishlist_btn[data-product-id="${productId}"]`);
                    relatedButtons.forEach(btn => {
                        if (btn !== wishlistBtn) {
                            if (isActive) {
                                btn.classList.remove('active');
                                btn.querySelector('i').className = 'ion-android-favorite-outline';
                                $(btn).tooltip('hide').attr('data-original-title', 'Add To Wishlist').tooltip('show');
                            } else {
                                btn.classList.add('active');
                                btn.querySelector('i').className = 'ion-android-favorite';
                                $(btn).tooltip('hide').attr('data-original-title', 'Remove from Wishlist').tooltip('show');
                            }
                        }
                    });
                } else {
                    let errorMessage = data.message || 'Failed to update wishlist';
                    if (errorMessage.includes('login') || response.status === 401) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Please Login',
                            text: 'Please login to manage your wishlist.',
                            confirmButtonText: 'OK'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = '/login';
                            }
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: errorMessage,
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 3000
                        });
                    }
                }
            } catch (error) {
                console.error('Error toggling wishlist:', error);
                Swal.fire({
                    icon: 'warning',
                    title: 'Please Login',
                    text: 'Please login to manage your wishlist.',
                    confirmButtonText: 'OK'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = '/login';
                    }
                });
            }
        }
    </script>
</body>
</html>