<%- include('../partials/admin/header') %>

<style>
    .table-responsive {
        margin-top: 20px;
    }
    .breadcrumbs {
        margin-bottom: 20px;
    }
    .breadcrumbs a {
        color: #000000;
        text-decoration: none;
        margin-right: 5px;
    }
    .breadcrumbs a:hover {
        text-decoration: underline;
    }
    .breadcrumbs span {
        margin: 0 5px;
    }
    .status-active {
        color: green;
        font-weight: bold;
    }
    .status-blocked {
        color: red;
        font-weight: bold;
    }
    
    /* Enhanced Table Styles */
    .table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }
    .table th, .table td {
        padding: 12px;
        vertical-align: middle;
        border-bottom: 1px solid #dee2e6;
    }
    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.9rem;
    }
    
    /* Description column styling */
    .description-cell {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        position: relative;
    }
    .description-cell:hover {
        white-space: normal;
        overflow: visible;
        background: #fff;
        z-index: 1;
        position: relative;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 8px;
    }
    
    /* Image styling */
    .category-image {
        max-width: 60px;
        max-height: 60px;
        object-fit: cover;
        border-radius: 4px;
    }
    
    /* Actions column styling */
    .action-buttons {
        display: flex;
        gap: 8px;
        justify-content: flex-start;
        flex-wrap: nowrap;
    }
    .action-buttons .btn {
        padding: 6px 12px;
        font-size: 0.875rem;
        min-width: 80px;
        text-align: center;
    }
    .table tr:hover {
        background-color: #f8f9fa;
    }
</style>

<section class="content-main">
    <div class="breadcrumbs">
        <% breadcrumbs.forEach((crumb, index) => { %>
            <% if (index < breadcrumbs.length - 1) { %>
                <a href="<%= crumb.url %>"><%= crumb.name %></a>
                <span>></span>
            <% } else { %>
                <%= crumb.name %>
            <% } %>
        <% }) %>
    </div>

    <div class="content-header">
        <h1 class="content-title card-title">Categories</h1>
        <div>
            <a href="/admin/addcategory" class="btn btn-dark">Add New Category</a>
        </div>
    </div>

    <div class="card-body">
        <!-- Search and Sort -->
        <div class="mb-4">
            <form method="get" action="/admin/categories" class="row g-3">
                <div class="col-md-4">
                    <input type="text" name="query" class="form-control" placeholder="Search categories" value="<%= searchQuery %>">
                </div>
                <div class="col-md-3">
                    <select name="sortBy" class="form-control">
                        <option value="createdAt" <%= sortBy === 'createdAt' ? 'selected' : '' %>>Created At</option>
                        <option value="name" <%= sortBy === 'name' ? 'selected' : '' %>>Name</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select name="sortOrder" class="form-control">
                        <option value="desc" <%= sortOrder === 'desc' ? 'selected' : '' %>>Descending</option>
                        <option value="asc" <%= sortOrder === 'asc' ? 'selected' : '' %>>Ascending</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-dark">Search</button>
                </div>
            </form>
        </div>

        <!-- Categories Table -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th style="width: 20%;">Name</th>
                        <th style="width: 35%;">Description</th>
                        <th style="width: 15%;">Image</th>
                        <th style="width: 10%;">Status</th>
                        <th style="width: 20%;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% categories.forEach(category => { %>
                        <tr>
                            <td><%= category.name %></td>
                            <td class="description-cell"><%= category.description %></td>
                            <td>
                                <% if (category.image) { %>
                                    <img src="/Uploads/categories/<%= category.image %>" alt="<%= category.name %>" class="category-image">
                                <% } %>
                            </td>
                            <td>
                                <span class="<%= category.status ? 'status-active' : 'status-blocked' %>">
                                    <%= category.status ? 'Active' : 'Blocked' %>
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a href="/admin/editCategory/<%= category._id %>" class="btn btn-sm btn-primary">Edit</a>
                                    <button class="btn btn-sm btn-warning toggle-status" data-id="<%= category._id %>">
                                        <%= category.status ? 'Block' : 'Unblock' %>
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-category" data-id="<%= category._id %>">Delete</button>
                                </div>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                <% if (currentPage > 1) { %>
                    <li class="page-item">
                        <a class="page-link" href="/admin/categories?page=<%= currentPage - 1 %>&query=<%= searchQuery %>&sortBy=<%= sortBy %>&sortOrder=<%= sortOrder %>">Previous</a>
                    </li>
                <% } %>
                <% for (let i = 1; i <= totalPages; i++) { %>
                    <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                        <a class="page-link" href="/admin/categories?page=<%= i %>&query=<%= searchQuery %>&sortBy=<%= sortBy %>&sortOrder=<%= sortOrder %>"><%= i %></a>
                    </li>
                <% } %>
                <% if (currentPage < totalPages) { %>
                    <li class="page-item">
                        <a class="page-link" href="/admin/categories?page=<%= currentPage + 1 %>&query=<%= searchQuery %>&sortBy=<%= sortBy %>&sortOrder=<%= sortOrder %>">Next</a>
                    </li>
                <% } %>
            </ul>
        </nav>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle category status
        document.querySelectorAll('.toggle-status').forEach(button => {
            button.addEventListener('click', function() {
                const categoryId = this.getAttribute('data-id');
                fetch(`/admin/toggleCategory/${categoryId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status !== undefined) {
                        const statusSpan = this.closest('tr').querySelector('.status-active, .status-blocked');
                        statusSpan.textContent = data.status ? 'Active' : 'Blocked';
                        statusSpan.className = data.status ? 'status-active' : 'status-blocked';
                        this.textContent = data.status ? 'Block' : 'Unblock';
                        alert(data.message);
                    } else {
                        alert(data.error || 'Failed to toggle category status');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while toggling category status');
                });
            });
        });

        // Delete category
        document.querySelectorAll('.delete-category').forEach(button => {
            button.addEventListener('click', function() {
                if (confirm('Are you sure you want to delete this category?')) {
                    const categoryId = this.getAttribute('data-id');
                    fetch(`/admin/deleteCategory/${categoryId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            this.closest('tr').remove();
                            alert(data.message);
                        } else {
                            alert(data.error || 'Failed to delete category');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while deleting category');
                    });
                }
            });
        });
    });
</script>

<%- include('../partials/admin/footer') %>